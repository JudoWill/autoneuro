---

title: Calculators


keywords: fastai
sidebar: home_sidebar



nb_path: "00_calculators.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 00_calculators.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.showdoc</span> <span class="kn">import</span> <span class="o">*</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AbstractCalculator" class="doc_header"><code>class</code> <code>AbstractCalculator</code><a href="https://github.com/judowill/autoneuro/tree/main/autoneuro/calculators.py#L17" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AbstractCalculator</code>(<strong><code>name</code></strong>, <strong><code>operations</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>However, you'll probably never need to use that directly.
Instead, you'll likely use the <a href="/autoneuro/calculators.html#TestCalculator"><code>TestCalculator</code></a>object.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TestCalculator" class="doc_header"><code>class</code> <code>TestCalculator</code><a href="https://github.com/judowill/autoneuro/tree/main/autoneuro/calculators.py#L116" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TestCalculator</code>(<strong><code>name</code></strong>, <strong><code>operations</code></strong>) :: <a href="/autoneuro/calculators.html#AbstractCalculator"><code>AbstractCalculator</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <a href="/autoneuro/calculators.html#TestCalculator"><code>TestCalculator</code></a> holds a sequential list of <code>operators.AbstractOperation</code> objects to perform on a single object.
While one could create these entirely in Python, its more likely that you'll load these from a set of <code>yaml</code> files.
Here's the example for the BVMT test.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>cat data/test_calculators/BVMT.yaml
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>name: &#39;Brief Visiospatial Memory Test&#39;
short_name: &#39;BVMT&#39;


operations:
  - type: equation
    equation: &#39;trial1+trial2+trial3&#39;
    fields: [&#39;trial1&#39;, &#39;trial2&#39;, &#39;trial3&#39;]
    out_field: immediate
  - type: agg
    method: &#39;max&#39;
    fields: [&#39;trial2&#39;, &#39;trial3&#39;]
    out_field: retention_denom
  - type: equation
    equation: &#39;delay/retention_denom&#39;
    fields: [ &#39;delay&#39;, &#39;retention_denom&#39;]
    out_field: retention
  - type: clip
    field: retention
    lower: 0
    upper: 1
  - type: equation
    equation: &#39;hits-false_pos&#39;
    fields: [&#39;hits&#39;, &#39;false_pos&#39;]
    out_field: &#39;recognition&#39;

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It defines how to calculate the <code>immediate</code>, <code>retention</code>, and <code>recognition</code> values from the raw measurements.
We can load this in from the <code>yaml</code> file easily.</p>
<p>We'll imagine an individual to test.</p>
<p>Measured Values:</p>
<ul>
<li><code>trial1</code> - 5</li>
<li><code>trial2</code> - 6</li>
<li><code>trial3</code> - 7</li>
<li><code>delay</code> - 8</li>
<li><code>hits</code> - 6</li>
<li><code>false_pos</code> - 2</li>
<li><code>copy</code> - 12</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">yaml</span>

<span class="n">DATA</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;trial1&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;trial2&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;trial3&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
        <span class="s1">&#39;delay&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;hits&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;false_pos&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;copy&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">}</span>


<span class="n">bvmt_calc</span> <span class="o">=</span> <span class="n">TestCalculator</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">full_load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;data/test_calculators/BVMT.yaml&#39;</span><span class="p">)))</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">bvmt_calc</span><span class="o">.</span><span class="n">process_single</span><span class="p">(</span><span class="n">DATA</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;immediate&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">18</span>
<span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;recognition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span>
<span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;retention&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="c1"># clipped from a raw 8/7</span>

<span class="n">bvmt_calc</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="n">DATA</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Input: 
 delay:8
 false_pos:2
 hits:6
 trial1:5
 trial2:6
 trial3:7
Calculating: [&#39;immediate&#39;]
Used Equation: trial1+trial2+trial3 = 18 = immediate 

Calculating: [&#39;retention_denom&#39;]
Aggregation: max [trial2, trial3]  = 7 

Calculating: [&#39;retention&#39;]
Used Equation: delay/retention_denom = 1.1428571428571428 = retention 

Calculating: [&#39;retention&#39;]
Clipped retention to [0, 1] 

Calculating: [&#39;recognition&#39;]
Used Equation: hits-false_pos = 4.0 = recognition 

Resulting in: 
 immediate:18.0
 recognition:4.0
 retention:1.0
 retention_denom:7.0
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Sweet! Everything got calculated automatically and I have easy descriptions of how each value was calculated.
What if I need to process a lot of data?</p>
<p>Put it into a <code>pd.DataFrame</code> and then use the <code>process_dataframe</code> method.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">DATA</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
<span class="n">bvmt_calc</span><span class="o">.</span><span class="n">process_dataframe</span><span class="p">(</span><span class="n">tdf</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>delay</th>
      <th>false_pos</th>
      <th>hits</th>
      <th>trial1</th>
      <th>trial2</th>
      <th>trial3</th>
      <th>immediate</th>
      <th>retention_denom</th>
      <th>retention</th>
      <th>recognition</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>8.0</td>
      <td>2.0</td>
      <td>6.0</td>
      <td>5.0</td>
      <td>6.0</td>
      <td>7.0</td>
      <td>18.0</td>
      <td>7.0</td>
      <td>1.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>8.0</td>
      <td>2.0</td>
      <td>6.0</td>
      <td>5.0</td>
      <td>6.0</td>
      <td>7.0</td>
      <td>18.0</td>
      <td>7.0</td>
      <td>1.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>8.0</td>
      <td>2.0</td>
      <td>6.0</td>
      <td>5.0</td>
      <td>6.0</td>
      <td>7.0</td>
      <td>18.0</td>
      <td>7.0</td>
      <td>1.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>8.0</td>
      <td>2.0</td>
      <td>6.0</td>
      <td>5.0</td>
      <td>6.0</td>
      <td>7.0</td>
      <td>18.0</td>
      <td>7.0</td>
      <td>1.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>8.0</td>
      <td>2.0</td>
      <td>6.0</td>
      <td>5.0</td>
      <td>6.0</td>
      <td>7.0</td>
      <td>18.0</td>
      <td>7.0</td>
      <td>1.0</td>
      <td>4.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Awesome, how do we deal with our full neuro data?
There are lots of different column names?
Easy, the <code>process_dataframe</code> allows for a mapping.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">all_neuro</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s1">&#39;data/neuro_data.xlsx&#39;</span><span class="p">,</span>
                          <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;na&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;nd&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;PatientID&#39;</span><span class="p">,</span> <span class="s1">&#39;Visit&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">all_neuro</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;Race&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;AA&#39;</span><span class="p">,</span>
                            <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span>
                            <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;asian&#39;</span><span class="p">},</span>
                   <span class="s1">&#39;Sex&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;male&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;female&#39;</span><span class="p">}},</span>
                  <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">all_neuro</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>VisitDate</th>
      <th>Age</th>
      <th>Sex</th>
      <th>Race</th>
      <th>Race_specify</th>
      <th>Education</th>
      <th>EngFluency</th>
      <th>SpanFluency</th>
      <th>MMSE</th>
      <th>DigitBackwardSENAS</th>
      <th>...</th>
      <th>Homeowner</th>
      <th>Householdsize</th>
      <th>Earnings.Indiv</th>
      <th>Income.Indiv</th>
      <th>Earnings.House</th>
      <th>Income.House</th>
      <th>Income.House.Weighted1</th>
      <th>Income.House.Weighted2</th>
      <th>Effort</th>
      <th>Unnamed: 165</th>
    </tr>
    <tr>
      <th>PatientID</th>
      <th>Visit</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">1</th>
      <th>1</th>
      <td>2014-11-10</td>
      <td>59</td>
      <td>male</td>
      <td>AA</td>
      <td>None</td>
      <td>10</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>29.0</td>
      <td>6.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>720.0</td>
      <td>0.0</td>
      <td>720.0</td>
      <td>720.0</td>
      <td>720.0</td>
      <td>5.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2018-01-09</td>
      <td>62</td>
      <td>male</td>
      <td>AA</td>
      <td>None</td>
      <td>11</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">2</th>
      <th>1</th>
      <td>2013-10-22</td>
      <td>62</td>
      <td>female</td>
      <td>AA</td>
      <td>None</td>
      <td>9</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>19.0</td>
      <td>2.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>730.0</td>
      <td>0.0</td>
      <td>1570.0</td>
      <td>785.0</td>
      <td>785.0</td>
      <td>4.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2018-03-13</td>
      <td>67</td>
      <td>female</td>
      <td>AA</td>
      <td>None</td>
      <td>10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <th>1</th>
      <td>2014-11-10</td>
      <td>65</td>
      <td>male</td>
      <td>AA</td>
      <td>None</td>
      <td>9</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>25.0</td>
      <td>4.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>720.0</td>
      <td>0.0</td>
      <td>720.0</td>
      <td>720.0</td>
      <td>720.0</td>
      <td>5.0</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows Ã— 164 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bvmt_calc</span><span class="o">.</span><span class="n">process_dataframe</span><span class="p">(</span><span class="n">all_neuro</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BVMTtrial1&#39;</span><span class="p">,</span> <span class="s1">&#39;BVMTdelay&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">(),</span>
                            <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;BVMTtrial1&#39;</span><span class="p">:</span> <span class="s1">&#39;trial1&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;BVMTtrial2&#39;</span><span class="p">:</span> <span class="s1">&#39;trial2&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;BVMTtrial3&#39;</span><span class="p">:</span> <span class="s1">&#39;trial3&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;BVMTdelay&#39;</span><span class="p">:</span> <span class="s1">&#39;delay&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;BVMThits&#39;</span><span class="p">:</span> <span class="s1">&#39;hits&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;BVMTfalsepos&#39;</span><span class="p">:</span> <span class="s1">&#39;false_pos&#39;</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>delay</th>
      <th>false_pos</th>
      <th>hits</th>
      <th>trial1</th>
      <th>trial2</th>
      <th>trial3</th>
      <th>immediate</th>
      <th>retention_denom</th>
      <th>retention</th>
      <th>recognition</th>
    </tr>
    <tr>
      <th>PatientID</th>
      <th>Visit</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <th>1</th>
      <td>0.0</td>
      <td>3.0</td>
      <td>6.0</td>
      <td>2.0</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>12.0</td>
      <td>5.0</td>
      <td>0.00</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>2</th>
      <th>1</th>
      <td>0.0</td>
      <td>3.0</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.00</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>4</th>
      <th>1</th>
      <td>4.0</td>
      <td>0.0</td>
      <td>4.0</td>
      <td>3.0</td>
      <td>4.0</td>
      <td>3.0</td>
      <td>10.0</td>
      <td>4.0</td>
      <td>1.00</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>5</th>
      <th>1</th>
      <td>7.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>3.0</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>13.0</td>
      <td>5.0</td>
      <td>1.00</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>8</th>
      <th>1</th>
      <td>3.0</td>
      <td>1.0</td>
      <td>5.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>1.0</td>
      <td>9.0</td>
      <td>4.0</td>
      <td>0.75</td>
      <td>4.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Awesome, a generic method for aggregating tests.
Can we then follow this with another normalization scheme.</p>
<p><a href="/autoneuro/calculators.html#TestCalculator"><code>TestCalculator</code></a>s can be added together to concatenate their operations.
This allows for a modular design of tests.
Since the BVMT test is common, but there are many normalization schemes, we can use the calculator multiple times.</p>
<p>Let's load in the <code>heaton</code> norms for BVMT test.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;data/norms/from_kate/heaton_bvmt.yaml&#39;</span>
<span class="n">heaton_bvmt_calc</span> <span class="o">=</span> <span class="n">TestCalculator</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">full_load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>

<span class="n">heaton_bvmt_calc</span><span class="o">.</span><span class="n">explain</span><span class="p">({</span><span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
                          <span class="s1">&#39;immediate&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
                          <span class="s1">&#39;retention&#39;</span><span class="p">:</span> <span class="mf">0.91</span><span class="p">,</span>
                          <span class="s1">&#39;delay&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
                          <span class="s1">&#39;recognition&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Input: 
 age:22
 delay:11
 immediate:30
 recognition:2
 retention:0.91
Calculating: [&#39;heaton_immediate&#39;]
heaton_immediate:
 Matched (20 &lt;= age) &amp; (age &lt;= 23)
 Expecting 28.44 +- 4.38
 Observed: 30.0
 Z: 0.35616438356164354 

Calculating: [&#39;heaton_retention&#39;]
heaton_retention:
 Matched (20 &lt;= age) &amp; (age &lt;= 23)
 Expecting 0.9493 +- 0.0726
 Observed: 0.91
 Z: -0.5413223140495869 

Calculating: [&#39;heaton_delay&#39;]
heaton_delay:
 Matched (20 &lt;= age) &amp; (age &lt;= 23)
 Expecting 10.68 +- 1.41
 Observed: 11.0
 Z: 0.2269503546099293 

Calculating: [&#39;heaton_recognition&#39;]
heaton_recognition:
 Matched (20 &lt;= age) &amp; (age &lt;= 23)
 Expecting 5.92 +- 0.26
 Observed: 2.0
 Z: -15.076923076923077 

Resulting in: 
 heaton_delay:0.2269503546099293
 heaton_immediate:0.35616438356164354
 heaton_recognition:-15.076923076923077
 heaton_retention:-0.5413223140495869
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can just <code>add</code> them!</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">full_calc</span> <span class="o">=</span> <span class="n">bvmt_calc</span> <span class="o">+</span> <span class="n">heaton_bvmt_calc</span>
<span class="n">full_calc</span><span class="o">.</span><span class="n">process_dataframe</span><span class="p">(</span><span class="n">all_neuro</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BVMTtrial1&#39;</span><span class="p">,</span> <span class="s1">&#39;BVMTdelay&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">(),</span>
                            <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;BVMTtrial1&#39;</span><span class="p">:</span> <span class="s1">&#39;trial1&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;BVMTtrial2&#39;</span><span class="p">:</span> <span class="s1">&#39;trial2&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;BVMTtrial3&#39;</span><span class="p">:</span> <span class="s1">&#39;trial3&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;BVMTdelay&#39;</span><span class="p">:</span> <span class="s1">&#39;delay&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;BVMThits&#39;</span><span class="p">:</span> <span class="s1">&#39;hits&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;BVMTfalsepos&#39;</span><span class="p">:</span> <span class="s1">&#39;false_pos&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Age&#39;</span><span class="p">:</span> <span class="s1">&#39;age&#39;</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>age</th>
      <th>delay</th>
      <th>false_pos</th>
      <th>hits</th>
      <th>trial1</th>
      <th>trial2</th>
      <th>trial3</th>
      <th>immediate</th>
      <th>retention_denom</th>
      <th>retention</th>
      <th>recognition</th>
      <th>heaton_immediate</th>
      <th>heaton_retention</th>
      <th>heaton_delay</th>
      <th>heaton_recognition</th>
    </tr>
    <tr>
      <th>PatientID</th>
      <th>Visit</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <th>1</th>
      <td>59.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>6.0</td>
      <td>2.0</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>12.0</td>
      <td>5.0</td>
      <td>0.00</td>
      <td>3.0</td>
      <td>-1.977737</td>
      <td>-10.770115</td>
      <td>-4.032864</td>
      <td>-6.500000</td>
    </tr>
    <tr>
      <th>2</th>
      <th>1</th>
      <td>62.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.00</td>
      <td>2.0</td>
      <td>-4.018553</td>
      <td>-10.770115</td>
      <td>-4.032864</td>
      <td>-8.772727</td>
    </tr>
    <tr>
      <th>4</th>
      <th>1</th>
      <td>65.0</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>4.0</td>
      <td>3.0</td>
      <td>4.0</td>
      <td>3.0</td>
      <td>10.0</td>
      <td>4.0</td>
      <td>1.00</td>
      <td>4.0</td>
      <td>-2.190909</td>
      <td>0.905172</td>
      <td>-1.986364</td>
      <td>-4.000000</td>
    </tr>
    <tr>
      <th>5</th>
      <th>1</th>
      <td>54.0</td>
      <td>7.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>3.0</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>13.0</td>
      <td>5.0</td>
      <td>1.00</td>
      <td>3.0</td>
      <td>-1.945076</td>
      <td>0.711744</td>
      <td>-0.882927</td>
      <td>-4.672414</td>
    </tr>
    <tr>
      <th>8</th>
      <th>1</th>
      <td>58.0</td>
      <td>3.0</td>
      <td>1.0</td>
      <td>5.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>1.0</td>
      <td>9.0</td>
      <td>4.0</td>
      <td>0.75</td>
      <td>4.0</td>
      <td>-2.702652</td>
      <td>-2.253855</td>
      <td>-2.834146</td>
      <td>-2.948276</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>norman</code> set regression norms have also been created in the same format.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;data/norms/norman/norman_scaling.yaml&#39;</span>
<span class="n">norman_scale</span> <span class="o">=</span> <span class="n">TestCalculator</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">full_load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>

<span class="n">DATA</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;male&#39;</span>
<span class="n">DATA</span><span class="p">[</span><span class="s1">&#39;race&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;AA&#39;</span>

<span class="n">norman_scaled_calc</span> <span class="o">=</span> <span class="n">bvmt_calc</span> <span class="o">+</span> <span class="n">norman_scale</span>
<span class="n">norman_scaled_calc</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="n">DATA</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Input: 
 delay:8
 false_pos:2
 gender:male
 hits:6
 race:AA
 trial1:5
 trial2:6
 trial3:7
Calculating: [&#39;immediate&#39;]
Used Equation: trial1+trial2+trial3 = 18 = immediate 

Calculating: [&#39;retention_denom&#39;]
Aggregation: max [trial2, trial3]  = 7 

Calculating: [&#39;retention&#39;]
Used Equation: delay/retention_denom = 1.1428571428571428 = retention 

Calculating: [&#39;retention&#39;]
Clipped retention to [0, 1] 

Calculating: [&#39;recognition&#39;]
Used Equation: hits-false_pos = 4 = recognition 

Calculating: [&#39;norman_gender&#39;]
gender:male -&gt; norman_gender:0 

Calculating: [&#39;norman_race&#39;]
race:AA -&gt; norman_race:1 

Calculating: [&#39;delay_scaled&#39;]
delay matched 8, scaled to 7 

Calculating: [&#39;immediate_scaled&#39;]
immediate matched 16, scaled to 6 

Resulting in: 
 delay_scaled:7
 immediate:18
 immediate_scaled:6
 norman_gender:0
 norman_race:1
 recognition:4
 retention:1.0
 retention_denom:7
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">reg_calc</span> <span class="o">=</span> <span class="n">TestCalculator</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">full_load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;data/norms/norman/norman_bvmt_regnorm.yaml&#39;</span><span class="p">)))</span>

<span class="n">full_norman</span> <span class="o">=</span> <span class="n">norman_scaled_calc</span> <span class="o">+</span> <span class="n">reg_calc</span>
<span class="n">DATA</span><span class="p">[</span><span class="s1">&#39;education&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">DATA</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span>

<span class="n">full_norman</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="n">DATA</span><span class="p">)</span>

<span class="c1">#reg_calc.operations[0].regressions[1][&#39;filter&#39;]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Input: 
 age:32
 delay:8
 education:6
 false_pos:2
 gender:male
 hits:6
 race:AA
 trial1:5
 trial2:6
 trial3:7
Calculating: [&#39;immediate&#39;]
Used Equation: trial1+trial2+trial3 = 18 = immediate 

Calculating: [&#39;retention_denom&#39;]
Aggregation: max [trial2, trial3]  = 7 

Calculating: [&#39;retention&#39;]
Used Equation: delay/retention_denom = 1.1428571428571428 = retention 

Calculating: [&#39;retention&#39;]
Clipped retention to [0, 1] 

Calculating: [&#39;recognition&#39;]
Used Equation: hits-false_pos = 4 = recognition 

Calculating: [&#39;norman_gender&#39;]
gender:male -&gt; norman_gender:0 

Calculating: [&#39;norman_race&#39;]
race:AA -&gt; norman_race:1 

Calculating: [&#39;delay_scaled&#39;]
delay matched 8, scaled to 7 

Calculating: [&#39;immediate_scaled&#39;]
immediate matched 16, scaled to 6 

Calculating: [&#39;norman_gender&#39;]
gender:male -&gt; norman_gender:0 

Calculating: [&#39;norman_race&#39;]
race:AA -&gt; norman_race:1 

Calculating: [&#39;delay_scaled&#39;]
delay matched 8, scaled to 7 

Calculating: [&#39;immediate_scaled&#39;]
immediate matched 16, scaled to 6 

Calculating: [&#39;norman_immediate&#39;]
Matched (norman_race == 1) &amp; ((age &gt;= 18) &amp; (age &lt;= 66)), applied ((immediate_scaled-(0.2834*(education-13.86)+(-0.1125)*(age-40.63)+1.0394*norman_gender + 8.0679))/2.5701)*10 + 50 = -0.31564958561923645 

Calculating: [&#39;norman_delay&#39;]
Matched (norman_race == 1) &amp; ((age &gt;= 18) &amp; (age &lt;= 66)), applied ((delay_scaled-(0.2267*(education-13.86) + (-0.1262)*(age-40.63) + 0.8593*norman_gender + 7.691))/2.5197)*10 + 50 = 0.0006969083621065408 

Resulting in: 
 delay_scaled:7
 immediate:18
 immediate_scaled:6
 norman_delay:0.0006969083621065408
 norman_gender:0
 norman_immediate:-0.31564958561923645
 norman_race:1
 recognition:4
 retention:1.0
 retention_denom:7
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And then we can do the full collection across the whole dataset easily.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">full_norman_heaton</span> <span class="o">=</span> <span class="n">bvmt_calc</span> <span class="o">+</span> <span class="n">heaton_bvmt_calc</span> <span class="o">+</span> <span class="n">norman_scale</span> <span class="o">+</span> <span class="n">reg_calc</span>


<span class="n">processed_data</span> <span class="o">=</span> <span class="n">full_norman_heaton</span><span class="o">.</span><span class="n">process_dataframe</span><span class="p">(</span><span class="n">all_neuro</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BVMTtrial1&#39;</span><span class="p">,</span> <span class="s1">&#39;BVMTdelay&#39;</span><span class="p">]),</span>
                            <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;BVMTtrial1&#39;</span><span class="p">:</span> <span class="s1">&#39;trial1&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;BVMTtrial2&#39;</span><span class="p">:</span> <span class="s1">&#39;trial2&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;BVMTtrial3&#39;</span><span class="p">:</span> <span class="s1">&#39;trial3&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;BVMTdelay&#39;</span><span class="p">:</span> <span class="s1">&#39;delay&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;BVMThits&#39;</span><span class="p">:</span> <span class="s1">&#39;hits&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;BVMTfalsepos&#39;</span><span class="p">:</span> <span class="s1">&#39;false_pos&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Sex&#39;</span><span class="p">:</span> <span class="s1">&#39;gender&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Race&#39;</span><span class="p">:</span> <span class="s1">&#39;race&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Education&#39;</span><span class="p">:</span> <span class="s1">&#39;education&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Age&#39;</span><span class="p">:</span> <span class="s1">&#39;age&#39;</span><span class="p">})</span>

<span class="n">processed_data</span><span class="p">[[</span><span class="s1">&#39;heaton_immediate&#39;</span><span class="p">,</span> <span class="s1">&#39;heaton_retention&#39;</span><span class="p">,</span> <span class="s1">&#39;heaton_delay&#39;</span><span class="p">,</span> <span class="s1">&#39;heaton_recognition&#39;</span><span class="p">,</span>
                <span class="s1">&#39;norman_immediate&#39;</span><span class="p">,</span> <span class="s1">&#39;norman_delay&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>heaton_immediate</th>
      <th>heaton_retention</th>
      <th>heaton_delay</th>
      <th>heaton_recognition</th>
      <th>norman_immediate</th>
      <th>norman_delay</th>
    </tr>
    <tr>
      <th>PatientID</th>
      <th>Visit</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <th>1</th>
      <td>-1.977737</td>
      <td>-10.770115</td>
      <td>-4.032864</td>
      <td>-6.500000</td>
      <td>-0.353041</td>
      <td>-0.991247</td>
    </tr>
    <tr>
      <th>2</th>
      <th>1</th>
      <td>-4.018553</td>
      <td>-10.770115</td>
      <td>-4.032864</td>
      <td>-8.772727</td>
      <td>-0.904965</td>
      <td>-1.092052</td>
    </tr>
    <tr>
      <th>4</th>
      <th>1</th>
      <td>-2.190909</td>
      <td>0.905172</td>
      <td>-1.986364</td>
      <td>-4.000000</td>
      <td>0.019863</td>
      <td>0.192982</td>
    </tr>
    <tr>
      <th>5</th>
      <th>1</th>
      <td>-1.945076</td>
      <td>0.711744</td>
      <td>-0.882927</td>
      <td>-4.672414</td>
      <td>-0.351368</td>
      <td>0.525759</td>
    </tr>
    <tr>
      <th>8</th>
      <th>1</th>
      <td>-2.702652</td>
      <td>-2.253855</td>
      <td>-2.834146</td>
      <td>-2.948276</td>
      <td>-1.006440</td>
      <td>-0.824401</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Awesome, pretty easy and only a few loading commands to do a whole analysis.</p>

</div>
</div>
</div>
</div>
 

